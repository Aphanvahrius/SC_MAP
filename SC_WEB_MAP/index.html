<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="initial-scale=1,user-scalable=no,maximum-scale=1,width=device-width">
        <meta name="mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-capable" content="yes">

        <link rel="stylesheet" href="css/specialElements.css">
        <link rel="stylesheet" href="css/leaflet.css">
        <link rel="stylesheet" href="css/leaflet-search.css">
        <link rel="stylesheet" href="css/fontawesome-all.min.css">
        <link rel="stylesheet" href="css/filter.css">
        <link rel="stylesheet" href="css/nouislider.min.css">
        <link rel="stylesheet" href="css/leaflet.fullscreen.css">

        <style>
            html, body, #map {
                width: 100%;
                height: 100%;
                padding: 0;
                margin: 0;
            }
            .spoiler {
                color: #800000;
                background-color: #aaaaba;
                padding: 2px 5px;
                cursor: pointer;
                font-weight: 900;
            }
            .spoiler:hover {
                text-decoration: underline;
            }
            .crossed {
                text-decoration: line-through;
            }
        </style>
        <title>ShipCore Interactive Map</title>
    </head>

    <body style="background-image: linear-gradient(to right, #0f0c29, #302b63, #24243e); color: #eeeefe; text-shadow: 0.2px 0.1px 1px rgba(80, 80, 80, 0.8); overflow: hidden;">
        <div id="map"></div>

        <script src="js/leaflet.min.js"></script>
        <script src="js/leaflet-svg-shape-markers.min.js"></script>
        <script src='js/Leaflet.fullscreen.js'></script>
        <script src="js/multi-style-layer.js"></script>
        <script src="js/leaflet-hash.min.js"></script>
        <script src="js/Autolinker.min.js"></script>
        <script src="js/rbush.min.js"></script>
        <script src="js/labelgun.min.js"></script>
        <script src="js/labels.js"></script>
        <script src="js/leaflet-search.js"></script>
        <script src="js/nouislider.min.js"></script>
        <script src="js/wNumb.js"></script>

        <script src="data/Regions_0.js"></script>
        <script src="data/Lanes_1.js"></script>
        <script src="data/Systems_2.js"></script>
        <script src="data/Sectors_3.js"></script>
        <script src="data/Characters_3.js"></script>
        <script src="data/Routes_5.js"></script>
        <script src="data/Diplomacy_4.js"></script>
        <script src="data/Subregions_5.js"></script>
        <script src="data/Mining_6.js"></script>
        <script src="data/Industrial_7.js"></script>
        <script src="data/Core_8.js"></script>
        <script src="data/Capital_9.js"></script>

        <script src="js/popups.js"></script>
        <script src="js/gradient-definitions.js"></script>
        <script src="js/layer-styles.js"></script>
        <script src="js/general-functions.js"></script>

        <svg width="0" height="0" style="position:absolute;"><defs></defs></svg>

        <script>
            // Create map
            var zoomOptions = {zoomControl:true, zoomSnap:0.5, zoomDelta:0.5, maxZoom:15, minZoom:10, zoom:10, maxBoundsViscosity: 0.85};
            var map = L.map('map', zoomOptions);

            var hash = new L.Hash(map);

            // Coords popup
            //map.on('click', display_Coords);

            // Create attributions
            map.attributionControl.setPrefix('\
                <a href="https://github.com/tomchadwin/qgis2web" target="_blank" rel="noopener noreferrer">qgis2web</a> &middot;\
                <a href="https://leafletjs.com" title="A JS library for interactive maps" target="_blank" rel="noopener noreferrer">Leaflet</a> &middot;\
                <a href="https://qgis.org" target="_blank" rel="noopener noreferrer">QGIS</a> &middot;\
                <a href="https://www.royalroad.com/fiction/41463/shipcore" target="_blank" rel="noopener noreferrer">ShipCore</a>',
            {position: null});

            // Create autolinker
            var autolinker = new Autolinker({truncate: {length: 30, location: 'smart'}});       

            //Create bounds group
            var bounds_group = new L.featureGroup([]);

            // Colect gradient fills for regions
            var gradientDefs = document.querySelector('svg defs');
            gradientDefs.appendChild(gradientStyleCS());
            gradientDefs.appendChild(gradientStyleHER());
            gradientDefs.appendChild(gradientStyleSF());
            gradientDefs.appendChild(gradientStyleSI());
            gradientDefs.appendChild(gradientStyleDoM());
            gradientDefs.appendChild(gradientStyleDoD());
            gradientDefs.appendChild(gradientStyleFPA());
            gradientDefs.appendChild(gradientStyleWFS());
            gradientDefs.appendChild(gradientStyleGS());
            gradientDefs.appendChild(gradientStyleSR());

            // Set layer order
            const order = {
                base: 290,
                Regions: 300,
                Diplomacy: 315,
                Subregions: 317,
                Lanes: 320,
                Characters: 340,
                Systems: 350,
                Mining: 351,
                Industrial: 352,
                Core: 353,
                Capital: 354
            };

            // Function to create a layer with its pane
            function createLayer(paneName, jsonData, options, addToMap = true, multiStyle = false) {
                map.createPane(paneName);
                map.getPane(paneName).style.zIndex = order[paneName.split('_')[1]];
                map.getPane(paneName).style['mix-blend-mode'] = 'normal';

                var layer;
                if (multiStyle) {
                    layer = new L.geoJson.multiStyle(jsonData, options);
                } else {
                    layer = new L.geoJson(jsonData, options);
                }

                bounds_group.addLayer(layer);
                if (addToMap) {
                    map.addLayer(layer);
                }
                return layer;
            }

            // Create regions layer
            var layer_Regions_0 = createLayer('pane_Regions_0', json_Regions_0, {
                attribution: '',
                interactive: true,
                dataVar: 'json_Regions_0',
                layerName: 'layer_Regions_0',
                pane: 'pane_Regions_0',
                onEachFeature: pop_Regions_0,
                style: style_Regions_0_0,
            });

            // Create starlanes layer
            var layer_Lanes_1 = createLayer('pane_Lanes_1', json_Lanes_1, {
                attribution: '',
                interactive: true,
                dataVar: 'json_Lanes_1',
                layerName: 'layer_Lanes_1',
                pane: 'pane_Lanes_1',
                onEachFeature: pop_Lanes_1,
                styles: [style_Lanes_1_0, style_Lanes_1_1]
            }, true, true);

            // Create star systems layer
            var layer_Systems_2 = createLayer('pane_Systems_2', json_Systems_2, {
                attribution: '',
                interactive: true,
                dataVar: 'json_Systems_2',
                layerName: 'layer_Systems_2',
                pane: 'pane_Systems_2',
                onEachFeature: pop_Systems_2,
                pointToLayer: function (feature, latlng) {
                    return L.circleMarker(latlng, style_Systems_2_0(feature));
                }
            });

            // Create characters' travels layer
            var layer_Characters_3 = createLayer('pane_Characters_3', json_Characters_3, {
                attribution: '',
                interactive: true,
                dataVar: 'json_Characters_3',
                layerName: 'layer_Characters_3',
                pane: 'pane_Characters_3',
                onEachFeature: pop_Characters_3,
                styles: [style_Characters_3_0, style_Characters_3_1]
            }, true, true);

            // Create diplomacy layer
            var layer_Diplomacy_4 = createLayer('pane_Diplomacy_4', json_Diplomacy_4, {
                attribution: '',
                interactive: true,
                dataVar: 'json_Diplomacy_4',
                layerName: 'layer_Diplomacy_4',
                pane: 'pane_Diplomacy_4',
                onEachFeature: pop_Diplomacy_4,
                style: style_Diplomacy_4_0,
            });

            // Create subregions layer (not added by default)
            var layer_Subregions_5 = createLayer('pane_Subregions_5', json_Subregions_5, {
                attribution: '',
                interactive: false,
                dataVar: 'json_Subregions_5',
                layerName: 'layer_Subregions_5',
                pane: 'pane_Subregions_5',
                style: style_Subregions_5_0,
            }, false);

            // Create Mining Systems Layer (not added by default)
            var layer_Mining_6 = createLayer('pane_Mining_6', json_Mining_6, {
                attribution: '',
                interactive: false,
                dataVar: 'json_Mining_6',
                layerName: 'layer_Mining_6',
                pane: 'pane_Mining_6',
                pointToLayer: function (feature, latlng) {
                    return L.shapeMarker(latlng, style_Mining_6(feature));
                }
            }, false);

            // Create Industrial Systems layer (not added by default)
            var layer_Industrial_7 = createLayer('pane_Industrial_7', json_Industrial_7, {
                attribution: '',
                interactive: false,
                dataVar: 'json_Industrial_7',
                layerName: 'layer_Industrial_7',
                pane: 'pane_Industrial_7',
                pointToLayer: function (feature, latlng) {
                    return L.shapeMarker(latlng, style_Industrial_7(feature));
                }
            }, false);

            // Create Core Systems layer (not added by default)
            var layer_Core_8 = createLayer('pane_Core_8', json_Core_8, {
                attribution: '',
                interactive: false,
                dataVar: 'json_Core_8',
                layerName: 'layer_Core_8',
                pane: 'pane_Core_8',
                pointToLayer: function (feature, latlng) {
                    return L.shapeMarker(latlng, style_Core_8(feature));
                }
            }, false);

            // Create Capital Systems layer (not added by default)
            var layer_Capital_9 = createLayer('pane_Capital_9', json_Capital_9, {
                attribution: '',
                interactive: false,
                dataVar: 'json_Capital_9',
                layerName: 'layer_Capital_9',
                pane: 'pane_Capital_9',
                pointToLayer: function (feature, latlng) {
                    return L.shapeMarker(latlng, style_Capital_9(feature));
                }
            }, false);

            var labelLayer_Systems_2 = L.layerGroup();

            // Call the function to add labels
            addLabelsToLayer(layer_Systems_2, labelLayer_Systems_2, "System_Nam", 11.5, 15);

            // Create system search tool
            map.addControl(new L.Control.Search({
                layer: layer_Systems_2,
                initial: false,
                hideMarkerOnCollapse: true,
                propertyName: 'System_Nam'
            }));
            document.getElementsByClassName('search-button')[0].className += ' fa fa-binoculars';

            // Create map fullscreen control
            map.addControl(new L.Control.Fullscreen());

            // Create legend
            var pointOverlays = {
                '<span class="layer-name">Systems</span><br />\
                <table>\
                    <tr>\
                        <td style="text-align: center;"><img src="legend/Systems_2_11.png" /></td>\
                        <td>Star System</td>\
                    </tr>\
                    <tr>\
                        <td style="text-align: center;"><img src="legend/Systems_2_00.png" /></td>\
                        <td>System With No Star</td>\
                    </tr>\
                </table>': layer_Systems_2,
                "System Names": labelLayer_Systems_2,
                '<span>Mining Systems</span><br />\
                <table>\
                    <tr>\
                        <td style="text-align: center;"><img src="legend/Mining_6.png" /></td>\
                        <td></td>\
                    </tr>\
                </table>': layer_Mining_6,
                '<span>Industrial Systems</span><br />\
                <table>\
                    <tr>\
                        <td style="text-align: center;"><img src="legend/Industrial_7.png" /></td>\
                        <td></td>\
                    </tr>\
                </table>': layer_Industrial_7,
                '<span>Core Systems</span><br />\
                <table>\
                    <tr>\
                        <td style="text-align: center;"><img src="legend/Core_8.png" /></td>\
                        <td></td>\
                    </tr>\
                </table>': layer_Core_8,
                '<span>Capital Systems</span><br />\
                <table>\
                    <tr>\
                        <td style="text-align: center;"><img src="legend/Capital_9.png" /></td>\
                        <td></td>\
                    </tr>\
                </table>': layer_Capital_9,
            }
          
            var pointControl = new L.control.layers(null, pointOverlays,{
                position: 'bottomleft',
                collapsed:true,
            });
            pointControl.addTo(map);

            var polygonOverlays = {
                '<span class="layer-name">Regions</span><br />\
                <table>\
                    <tr>\
                        <td style="text-align: center;"><img src="legend/Regions_0_CorporateSystems0.png" /></td>\
                        <td>Corporate Systems</td>\
                    </tr>\
                    <tr>\
                        <td style="text-align: center;"><img src="legend/Regions_0_DuchyOfDrakar1.png" /></td>\
                        <td>Duchy Of Drakar</td>\
                    </tr>\
                    <tr>\
                        <td style="text-align: center;"><img src="legend/Regions_0_DuchyOfMeltisar2.png" /></td>\
                        <td>Duchy Of Meltisar</td>\
                    </tr>\
                    <tr>\
                        <td style="text-align: center;"><img src="legend/Regions_0_FreePlanetsAlliance3.png" /></td>\
                        <td>Free Planets Alliance</td>\
                    </tr>\
                    <tr>\
                        <td style="text-align: center;"><img src="legend/Regions_0_GhostSector4.png" /></td>\
                        <td>Ghost Sector</td>\
                    </tr>\
                    <tr>\
                        <td style="text-align: center;"><img src="legend/Regions_0_HolyErtanRepublic5.png" /></td>\
                        <td>Holy Ertan Republic</td>\
                    </tr>\
                    <tr>\
                        <td style="text-align: center;"><img src="legend/Regions_0_SolarImperium6.png" /></td>\
                        <td>Solar Imperium</td>\
                    </tr>\
                    <tr>\
                        <td style="text-align: center;"><img src="legend/Regions_0_SolarianFederation7.png" /></td>\
                        <td>Solarian Federation</td>\
                    </tr>\
                    <tr>\
                        <td style="text-align: center;"><img src="legend/Regions_0_TheWesternFrontierSystems8.png" /></td>\
                        <td>The Western Frontier Systems</td>\
                    </tr>\
                    <tr>\
                        <td style="text-align: center;"><img src="legend/Regions_0_StarlightRevolution9.png" /></td>\
                        <td>Starlight Revolution</td>\
                    </tr>\
                </table>': layer_Regions_0,

                '<span class="layer-name">Diplomacy</span><br />\
                <table>\
                    <tr>\
                        <td style="text-align: center;"><img src="legend/Diplomacy_4_Self0.png" /></td>\
                        <td>Self</td>\
                    </tr>\
                    <tr>\
                        <td style="text-align: center;"><img src="legend/Diplomacy_4_Friendly1.png" /></td>\
                        <td>Friendly</td>\
                    </tr>\
                    <tr>\
                        <td style="text-align: center;"><img src="legend/Diplomacy_4_Amicable2.png" /></td>\
                        <td>Amicable</td>\
                    </tr>\
                    <tr>\
                        <td style="text-align: center;"><img src="legend/Diplomacy_4_Neutral3.png" /></td>\
                        <td>Neutral</td>\
                    </tr>\
                    <tr>\
                        <td style="text-align: center;"><img src="legend/Diplomacy_4_Reserved4.png" /></td>\
                        <td>Reserved</td>\
                    </tr>\
                    <tr>\
                        <td style="text-align: center;"><img src="legend/Diplomacy_4_Hostile5.png" /></td>\
                        <td>Hostile</td>\
                    </tr>\
                    <tr>\
                        <td style="text-align: center;"><img src="legend/Diplomacy_4_AtWar6.png" /></td>\
                        <td>At War</td>\
                    </tr>\
                </table>': layer_Diplomacy_4,                
            }
            var polygonControl = new L.control.layers(null,polygonOverlays,{
                position: 'topright',
                collapsed: false
            });
            polygonControl.addTo(map);

            var lineOverlays = {
                '<span class="layer-name">Subregions</span><br />': layer_Subregions_5,
                
                '<span class="layer-name">Lanes</span><br />\
                <table>\
                    <tr>\
                        <td style="text-align: center;"><img src="legend/Lanes_1_InDevelopement0.png" /></td>\
                        <td>In Developement</td>\
                    </tr>\
                    <tr>\
                        <td style="text-align: center;"><img src="legend/Lanes_1_Operational1.png" /></td>\
                        <td>Operational</td>\
                    </tr>\
                </table>': layer_Lanes_1,

                '<span class="layer-name">Character Journey</span><br />\
                <table>\
                    <tr>\
                        <td style="text-align: center;"><img src="legend/Characters_3_Abbey0.png" /></td>\
                        <td>Abbey</td>\
                    </tr>\
                    <tr>\
                        <td style="text-align: center;"><img src="legend/Characters_3_Alex1.png" /></td>\
                        <td>Alex</td>\
                    </tr>\
                    <tr>\
                        <td style="text-align: center;"><img src="legend/Characters_3_Elis2.png" /></td>\
                        <td>Elis</td>\
                    </tr>\
                    <tr>\
                        <td style="text-align: center;"><img src="legend/Characters_3_Thea3.png" /></td>\
                        <td>Thea</td>\
                    </tr>\
                    <tr>\
                        <td style="text-align: center;"><img src="legend/Characters_3_Tia4.png" /></td>\
                        <td>Tia</td>\
                    </tr>\
                </table>': layer_Characters_3,
            }
            var lineControl = new L.control.layers(null,lineOverlays,{
                position: 'topleft',
                collapsed: true
            });
            lineControl.addTo(map);
            
            map.on("zoomend", function(){
                if (map.hasLayer(layer_Systems_2)) {
                    if (map.getZoom() <= 10 && map.getZoom() >= 15) {
                            layer_Systems_2.eachLayer(function (layer) {
                                layer.openTooltip();
                            });
                        } else {
                            layer_Systems_2.eachLayer(function (layer) {
                                layer.closeTooltip();
                            });
                        }
                    }
            });

            setBounds();
            if (map.hasLayer(layer_Systems_2)) {
                if (map.getZoom() <= 10 && map.getZoom() >= 15) {
                    layer_Systems_2.eachLayer(function (layer) {
                        layer.openTooltip();
                    });
                } else {
                    layer_Systems_2.eachLayer(function (layer) {
                        layer.closeTooltip();
                    });
                }
            }

            // Define website structure
            var row = document.createElement('div');
            row.className = "row";
            row.id = "all";
            row.style.height = "100%";

            var col1 = document.createElement('div');
            col1.className = "col9";
            col1.id = "mapWindow";
            col1.style.height = "100%";
            col1.style.width = "80%";
            col1.style.display = "inline-block";

            var col2 = document.createElement('div');
            col2.className = "col3";
            col2.id = "menu";
            col2.style.display = "inline-block";

            var mapDiv = document.getElementById('map');
            mapDiv.style.height = "93%";
            mapDiv.parentNode.insertBefore(row, mapDiv);
            document.getElementById("all").appendChild(col1);
            document.getElementById("all").appendChild(col2);

            var mapTitle = document.createElement('div');
            mapTitle.innerHTML = 'Shipcore Interactive Map';
            mapTitle.className = 'maptitle';
            mapTitle.style.height = "7%";

            var menuTitle = document.createElement('div');
            menuTitle.innerHTML = 'Filters';
            menuTitle.className = 'maptitle';
            menuTitle.style.height = "7%";

            col1.appendChild(mapTitle);
            col1.appendChild(mapDiv);
            col2.appendChild(menuTitle);

            // Create tab structure
            const tabContainer = document.createElement('div');
            tabContainer.className = 'tab';

            const tabButton1 = document.createElement('button');
            tabButton1.className = 'tablinks';
            tabButton1.innerHTML = 'Main';
            tabButton1.onclick = function () {
                openTab(event, 'mainTab');
            };
            tabContainer.appendChild(tabButton1);

            const tabButton2 = document.createElement('button');
            tabButton2.className = 'tablinks';
            tabButton2.innerHTML = 'Other';
            tabButton2.onclick = function () {
                openTab(event, 'otherTab');
            };
            tabContainer.appendChild(tabButton2);

            const tabButton3 = document.createElement('button');
            tabButton3.className = 'tablinks';
            tabButton3.innerHTML = 'Real Distances';
            tabButton3.onclick = function () {
                openTab(event, 'distancesTab');
            };
            tabContainer.appendChild(tabButton3);

            col2.appendChild(tabContainer);

            const mainTab = document.createElement('div');
            mainTab.id = 'mainTab';
            mainTab.className = 'tabcontent';
            col2.appendChild(mainTab);

            const otherTab = document.createElement('div');
            otherTab.id = 'otherTab';
            otherTab.className = 'tabcontent';
            col2.appendChild(otherTab);

            const distancesTab = document.createElement('div');
            distancesTab.id = 'distancesTab';
            distancesTab.className = 'tabcontent';
            col2.appendChild(distancesTab);

            // Set the first tab as active by default
            tabButton1.classList.add('active');
            mainTab.classList.add('active');

            // Function to open tabs
            function openTab(evt, tabName) {
                var i, tabcontent, tablinks;
                tabcontent = document.getElementsByClassName('tabcontent');
                for (i = 0; i < tabcontent.length; i++) {
                    tabcontent[i].classList.remove('active');
                }
                tablinks = document.getElementsByClassName('tablinks');
                for (i = 0; i < tablinks.length; i++) {
                    tablinks[i].classList.remove('active');
                }
                document.getElementById(tabName).classList.add('active');
                evt.currentTarget.classList.add('active');
            }
            
            // Define filter variables
            var Filters = {
                "Orbtl_Clny": "int",
                "Inhabitabl": "int",
                "Nation": "str",
                "Star_Presc": "str",
                "Unsurv_bod": "str",
                "New_Lane": "str",
                "System_Nam": "str",
                "Type": "str",
                "Status": "str",
                "Character": "str",
                "Book": "str",
            };
            
            // Main filtering function
            function filterFunc() {
                map.eachLayer(function(lyr){
                    if ("options" in lyr && "dataVar" in lyr["options"]){
                        features = this[lyr["options"]["dataVar"]].features.slice(0);
                        try{
                            for (key in Filters){
                                keyS = key.replace(/[^a-zA-Z0-9_]/g, "")
                                if (Filters[key] == "str" || Filters[key] == "bool"){
                                    var selection = [];
                                    var options = document.getElementById("sel_" + keyS).options
                                    for (var i=0; i < options.length; i++) {
                                        if (options[i].selected) selection.push(options[i].value);
                                    }
                                    try{
                                        if (key in features[0].properties){
                                            for (i = features.length - 1; i >= 0; --i){
                                                if (selection.indexOf(features[i].properties[key])<0 && selection.length>0) {
                                                    features.splice(i,1);
                                                }
                                            }
                                        }
                                    } catch(err){}
                                }

                                if (Filters[key] == "int"){
                                    sliderVals =  document.getElementById("div_" + keyS).noUiSlider.get();
                                    try{
                                        if (key in features[0].properties){
                                            for (i = features.length - 1; i >= 0; --i){
                                                var propertyValue = parseInt(features[i].properties[key]);
                                                if (isNaN(propertyValue)){
                                                    propertyValue = 0;
                                                }
                                                if (propertyValue < sliderVals[0] || propertyValue > sliderVals[1]){
                                                        features.splice(i,1);
                                                }
                                            }
                                        }
                                    } catch(err){}
                                }

                                if (Filters[key] == "real"){
                                    sliderVals =  document.getElementById("div_" + keyS).noUiSlider.get();
                                    try{
                                        if (key in features[0].properties){
                                            for (i = features.length - 1; i >= 0; --i){
                                                var propertyValue = parseFloat(features[i].properties[key]);
                                                if (isNaN(propertyValue)){
                                                    propertyValue = 0;
                                                }
                                                if (propertyValue < sliderVals[0] || propertyValue > sliderVals[1]){
                                                        features.splice(i,1);
                                                }
                                            }
                                        }
                                    } catch(err){}
                                }

                                if (Filters[key] == "date" || Filters[key] == "datetime" || Filters[key] == "time"){
                                    try{
                                        if (key in features[0].properties){
                                            HTMLkey = key.replace(/[&\/\\#,+()$~%.'":*?<>{} ]/g, '');
                                            startdate = document.getElementById("dat_" + HTMLkey + "_date1").value.replace(" ", "T");
                                            enddate = document.getElementById("dat_" + HTMLkey + "_date2").value.replace(" ", "T");
                                            for (i = features.length - 1; i >= 0; --i){
                                                if (features[i].properties[key] < startdate || features[i].properties[key] > enddate){
                                                    features.splice(i,1);
                                                }
                                            }
                                        }
                                    } catch(err){}
                                }
                            }
                        } catch(err){}
                        this[lyr["options"]["layerName"]].clearLayers();
                        this[lyr["options"]["layerName"]].addData(features);
                    }
                })
            }

            // Function to create a slider filter
            function createSliderFilter(id, label, min, max, step, start, format) {
                const labelDiv = document.createElement('div');
                labelDiv.innerHTML = `${label}: <span id="val_${id}"></span>`;
                labelDiv.className = 'filterlabel';
                document.getElementById('otherTab').appendChild(labelDiv);

                const resetDiv = document.createElement('div');
                resetDiv.innerHTML = '<button>clear filter</button>';
                resetDiv.className = 'filterlabel';
                resetDiv.onclick = function() {
                    slider.noUiSlider.reset();
                };
                document.getElementById('otherTab').appendChild(resetDiv);

                const sliderDiv = document.createElement("div");
                sliderDiv.id = `div_${id}`;
                sliderDiv.className = "slider";
                document.getElementById('otherTab').appendChild(sliderDiv);

                const slider = document.getElementById(`div_${id}`);
                noUiSlider.create(slider, {
                    connect: true,
                    start: start,
                    step: step,
                    format: format,
                    range: { min: min, max: max }
                });

                slider.noUiSlider.on('update', function (values) {
                    const valDiv = document.getElementById(`val_${id}`);
                    valDiv.innerHTML = values.join(' - ');
                    filterFunc();
                });
            }

            // Create Orbital/Colony Slider Filter
            createSliderFilter('Orbtl_Clny', 'Turning off lanes recommended<br/>ORBITALS / COLONIES', 0, 258, 1, [0, 258], wNumb({ decimals: 0 }));

            // Create Inhabitable Planets Slider Filter
            createSliderFilter('Inhabitabl', 'INHABITABLE WORLDS', 0, 4, 1, [0, 4], wNumb({ decimals: 0 }));

            // Function to create a select filter
            function createSelectFilter(id, label, options, size, multiple = true, isSystemFilter = false) {
                const container = document.createElement('div');
                container.id = `div_${id}`;
                container.className = "filterselect";

                const labelDiv = document.createElement('div');
                labelDiv.innerHTML = label;
                labelDiv.className = 'filterlabel';
                container.appendChild(labelDiv);

                const resetDiv = document.createElement('div');
                resetDiv.innerHTML = '<button>clear filter</button>';
                resetDiv.className = 'filterlabel';
                resetDiv.onclick = function() {
                    const select = document.getElementById(`sel_${id}`);
                    for (let i = 0; i < select.options.length; i++) {
                        select.options[i].selected = false;
                    }
                    if (isSystemFilter) {
                        clearSystemLabels();
                    } else {
                        filterFunc();
                    }
                };
                container.appendChild(resetDiv);

                const select = document.createElement('select');
                select.id = `sel_${id}`;
                if (multiple) {
                    select.multiple = true;
                }
                select.size = size;
                select.onchange = function() {
                    if (isSystemFilter) {
                        handleSystemSelection();
                    } else {
                        filterFunc();
                    }
                };

                let optionsStr = "";
                for (const option of options) {
                    const optionLabel = option.label || option.value;
                    optionsStr += `<option value="${option.value}">${optionLabel}</option>`;
                }
                select.innerHTML = optionsStr;
                container.appendChild(select);

                return container;
            }
            
            // Function to clear system labels
            function clearSystemLabels() {
                layer_Systems_2.eachLayer(function (layer) {
                    layer.unbindTooltip();
                });
            }

            // Function to handle system selection
            function handleSystemSelection() {
                clearSystemLabels(); // Clear any existing labels

                const select = document.getElementById('sel_System_Nam');
                const selectedSystem = select.value;
                const selectedFeature = json_Systems_2.features.find(f => f.properties.System_Nam === selectedSystem);
                
                if (selectedFeature) {
                    const selected_X = Number(selectedFeature.properties.X);
                    const selected_Y = Number(selectedFeature.properties.Y);
                    const selected_Z = Number(selectedFeature.properties.Z);
                    const systemValues = json_Systems_2.features.map(f => {
                        return {
                            name: f.properties.System_Nam,
                            value: Math.sqrt(
                                Math.pow(selected_X - Number(f.properties.X), 2) +
                                Math.pow(selected_Y - Number(f.properties.Y), 2) +
                                Math.pow(selected_Z - Number(f.properties.Z), 2)
                            ).toFixed(2)
                        };
                    });

                    displaySystemValues(systemValues, selectedSystem);
                }
            }

            // Function to display system values
            function displaySystemValues(systemValues, selectedSystem) {
                layer_Systems_2.eachLayer(function (layer) {
                    const systemName = layer.feature.properties.System_Nam;
                    if (systemName === selectedSystem) {
                        // Display special label for the selected system
                        layer.bindTooltip("You", { permanent: true, direction: 'right', className: 'distance-tooltip-selected' }).openTooltip();
                    } else {
                        const systemValue = systemValues.find(sv => sv.name === systemName)?.value;

                        if (systemValue !== undefined) {
                            layer.bindTooltip(systemValue.toString(), { permanent: true, direction: 'right', className: 'distance-tooltip' }).openTooltip();
                        } else {
                            layer.unbindTooltip();
                        }
                    }
                });
                updateTooltipFontSize();
            }

            // Function to update tooltip font size based on zoom level
            function updateTooltipFontSize() {
                const zoomLevel = map.getZoom();
                const fontSize = Math.pow(zoomLevel - 6.5, 1.6) + 'px'; // Adjust the calculation as needed

                const tooltips = document.getElementsByClassName('distance-tooltip');
                for (let i = 0; i < tooltips.length; i++) {
                    tooltips[i].style.fontSize = fontSize;
                }
            }
            
            // Debounce function to limit the rate of execution
            function debounce(func, wait) {
                let timeout;
                return function() {
                    clearTimeout(timeout);
                    timeout = setTimeout(func, wait);
                };
            }

            // Event listener to handle zoom end for performance optimization
            map.on('zoomend', debounce(function() {
                const select = document.getElementById('sel_System_Nam');
                if (select.value) {
                    handleSystemSelection(); // Recalculate and display labels on zoom
                }
                updateTooltipFontSize(); // Update font size on zoom
            }, 300)); // Adjust debounce delay as necessary

            // Initial font size adjustment
            updateTooltipFontSize();

            // Create Region Select Filter
            const regionFilter = createSelectFilter('Nation', 'REGION / DIPLOMACY', [
                { value: "Corporate Systems"},
                { value: "Duchy of Drakar"},
                { value: "Duchy of Meltisar"},
                { value: "Free Planets Alliance"},
                { value: "Ghost Sector"},
                { value: "Holy Ertan Republic"},
                { value: "Solar Imperium"},
                { value: "Solarian Federation"},
                { value: "Starlight Revolution"},
                { value: "The Western Frontier Systems"}
            ], 6, false);
            document.getElementById('mainTab').appendChild(regionFilter);

            // Create Book Volume Select Filter
            const bookFilter = createSelectFilter('Book', 'BOOK', [
                { value: "A1"},
                { value: "A2"},
                { value: "A3"},
                { value: "A4"}
            ], 4);
            document.getElementById('mainTab').appendChild(bookFilter);

            // Create Character Select Filter
            const characterFilter = createSelectFilter('Character', 'CHARACTER', [
                { value: "Abbey"},
                { value: "Alex"},
                { value: "Elis"},
                { value: "Thea"},
                { value: "Tia"}
            ], 5);
            document.getElementById('mainTab').appendChild(characterFilter);

            // Create System Star Presence Select Filter
            const starFilter = createSelectFilter('Star_Presc', 'STAR PRESENCE IN SYSTEM', [
                { value: "1", label: "Yes" },
                { value: "0", label: "No" }
            ], 2, false);
            document.getElementById('mainTab').appendChild(starFilter);

            // Create Unsurveyed Bodies Select Filter
            const UnsurvBodsFilter = createSelectFilter('Unsurv_bod', 'SYSTEMS WITH UNSURVEYED BODIES', [
                { value: "1", label: "Show" }
            ], 1);
            document.getElementById('otherTab').appendChild(UnsurvBodsFilter);

            // Create New Lane Select Filter
            const newLaneFilter = createSelectFilter('New_Lane', 'SYSTEMS WHERE A NEW STARLINE IS BEING RESEARCHED', [
                { value: "1", label: "Show" }
            ], 1);
            document.getElementById('otherTab').appendChild(newLaneFilter);

            // Create Lane Type Select Filter
            const laneTypeFilter = createSelectFilter('Type', 'STARLANE TYPE', [
                { value: "International"},
                { value: "National"}
            ], 2, false);
            document.getElementById('otherTab').appendChild(laneTypeFilter);

            // Create Lane Status Select Filter
            const laneStatusFilter = createSelectFilter('Status', 'STARLANE STATUS', [
                { value: "In Developement"},
                { value: "Operational"}
            ], 2, false);
            document.getElementById('otherTab').appendChild(laneStatusFilter);

            // Create Systems Select Filter
            systemFilter = createSelectFilter('System_Nam', 'FROM<br/>Recommended zoom 12+', [
                { value: "1 Octantis" },
                { value: "1 Pavonis" },
                { value: "10 Cassiopeiae" },
                { value: "101 Leonis" },
                { value: "102 Leonis" },
                { value: "103 Leonis" },
                { value: "104 Ceti" },
                { value: "106 Draconis" },
                { value: "107 Piscium" },
                { value: "109 Aquarii" },
                { value: "110 Aquarii" },
                { value: "111 Ceti" },
                { value: "111 Virginis" },
                { value: "112 Virginis" },
                { value: "113 Aquarii" },
                { value: "113 Virginis" },
                { value: "114 Aquarii" },
                { value: "114 Ceti" },
                { value: "114 Piscium" },
                { value: "114 Virginis" },
                { value: "115 Aquarii" },
                { value: "115 Herculis" },
                { value: "115 Piscium" },
                { value: "115 Virginis" },
                { value: "116 Ceti" },
                { value: "116 Herculis" },
                { value: "116 Piscium" },
                { value: "116 Ursae Majoris" },
                { value: "116 Virginis" },
                { value: "117 Virginis" },
                { value: "118 Piscium" },
                { value: "118 Virginis" },
                { value: "119 Herculis" },
                { value: "119 Piscium" },
                { value: "119 Virginis" },
                { value: "120 Herculis" },
                { value: "120 Piscium" },
                { value: "120 Virginis" },
                { value: "121 Aquarii" },
                { value: "121 Piscium" },
                { value: "121 Virginis" },
                { value: "122 Piscium" },
                { value: "123 Piscium" },
                { value: "124 Herculis" },
                { value: "124 Virginis" },
                { value: "125 Piscium" },
                { value: "125 Virginis" },
                { value: "126 Piscium" },
                { value: "126 Virginis" },
                { value: "13 Centauri" },
                { value: "131 Virginis" },
                { value: "132 Virginis" },
                { value: "135 Virginis" },
                { value: "14 Centauri" },
                { value: "142 Tauri" },
                { value: "144 Tauri" },
                { value: "15 Cassiopeiae" },
                { value: "16 Cassiopeiae" },
                { value: "2 Octantis" },
                { value: "25 Ursae Minoris" },
                { value: "36 Cephei" },
                { value: "52 Capricorni" },
                { value: "56 Cassiopeiae" },
                { value: "57 Cassiopeiae" },
                { value: "6 Centauri" },
                { value: "6 Lupi" },
                { value: "61 Hydrae" },
                { value: "61 Virginis" },
                { value: "63 Hydrae" },
                { value: "64 Hydrae" },
                { value: "69 Andromedae" },
                { value: "7 Centauri" },
                { value: "7 Octantis" },
                { value: "70 Andromedae" },
                { value: "70 Hydrae" },
                { value: "73 Eridani" },
                { value: "75 Ophiuchi" },
                { value: "76 Ophiuchi" },
                { value: "78 Ophiuchi" },
                { value: "80 Ophiuchi" },
                { value: "81 Draconis" },
                { value: "81 Orionis" },
                { value: "82 Eridani" },
                { value: "83 Draconis" },
                { value: "84 Cancri" },
                { value: "84 Orionis" },
                { value: "85 Ophiuchi" },
                { value: "85 Orionis" },
                { value: "86 Draconis" },
                { value: "86 Geminorum" },
                { value: "87 Draconis" },
                { value: "88 Draconis" },
                { value: "88 Ophiuchi" },
                { value: "89 Ursae Majoris" },
                { value: "9 Centauri" },
                { value: "90 Pegasi" },
                { value: "90 Ursae Majoris" },
                { value: "91 Draconis" },
                { value: "91 Orionis" },
                { value: "92 Pegasi" },
                { value: "94 Ursae Majoris" },
                { value: "96 Draconis" },
                { value: "97 Draconis" },
                { value: "97 Pegasi" },
                { value: "97 Ursae Majoris" },
                { value: "98 Ceti" },
                { value: "98 Pegasi" },
                { value: "99 Ceti" },
                { value: "99 Leonis" },
                { value: "99 Ursae Majoris" },
                { value: "AD Leonis" },
                { value: "AU Microscopii" },
                { value: "AX Microscopii" },
                { value: "Alpha Centauri" },
                { value: "Alpha Leonis Minoris" },
                { value: "Alpha Normae" },
                { value: "Alpha Velorum" },
                { value: "Altair" },
                { value: "Barnard&apos;s Star" },
                { value: "Beta Antliae" },
                { value: "Beta Hydri" },
                { value: "Beta Puppis" },
                { value: "Beta Telescopii" },
                { value: "Beta Virginis" },
                { value: "CD Ceti" },
                { value: "Chi Arietis" },
                { value: "Chi Cephei" },
                { value: "Chi Draconis" },
                { value: "Chi Librae" },
                { value: "DX Cancri" },
                { value: "Delta Camelopardalis" },
                { value: "Delta Capricorni" },
                { value: "Delta Carinae" },
                { value: "Delta Pavonis" },
                { value: "Delta Pegasi" },
                { value: "Donner 91" },
                { value: "EV Lacertae" },
                { value: "EZ Aquarii" },
                { value: "Epsilon Eridani" },
                { value: "Epsilon Horologii" },
                { value: "Epsilon Indi" },
                { value: "Eta Bo√∂tis" },
                { value: "Eta Cassiopeiae" },
                { value: "Eta Monocerotis" },
                { value: "Eta Sextantis" },
                { value: "FL Virginis" },
                { value: "FN Virginis" },
                { value: "GL Virginis" },
                { value: "Gamma Carinae" },
                { value: "Gamma Leporis" },
                { value: "Gamma Telescopii" },
                { value: "Gamma Virginis" },
                { value: "Gliese 290" },
                { value: "Groombridge 34" },
                { value: "HD 222834" },
                { value: "HH Andromedae" },
                { value: "Heintz 299" },
                { value: "Iota Comae Berenices" },
                { value: "Kappa Camelopardalis" },
                { value: "Kappa Muscae" },
                { value: "Kapteyn&apos;s Star" },
                { value: "Kruger 60" },
                { value: "Lacaille 9352" },
                { value: "Lalande" },
                { value: "Lambda Indi" },
                { value: "Lambda Volantis" },
                { value: "Luhman 16" },
                { value: "Mu Camelopardalis" },
                { value: "Mu Delphini" },
                { value: "Mu Pyxidis" },
                { value: "Mu Reticuli" },
                { value: "Mu Tucanae" },
                { value: "Mu Ursae Minoris" },
                { value: "Nu Crateris" },
                { value: "Nu Muscae" },
                { value: "Nu Reticuli" },
                { value: "Nu Ursae Minoris" },
                { value: "Omega Arietis" },
                { value: "Omega Ceti" },
                { value: "Omega Gruis" },
                { value: "Omega Sculptoris" },
                { value: "Omicron Chamaeleontis" },
                { value: "Omicron Hydri" },
                { value: "Omicron Lyrae" },
                { value: "Omikron Mensae" },
                { value: "P Eridani" },
                { value: "Phi Arietis" },
                { value: "Phi Librae" },
                { value: "Pi Leporis" },
                { value: "Pi Librae" },
                { value: "Pi Pyxidis" },
                { value: "Pi-3 Orionis" },
                { value: "Pollux" },
                { value: "Proxima Centauri" },
                { value: "Psi Arietis" },
                { value: "Psi Cephei" },
                { value: "Psi Ceti" },
                { value: "Psi Gruis" },
                { value: "Psi Herculis" },
                { value: "QY Aurigae" },
                { value: "Rho Canis Majoris" },
                { value: "Rho Librae" },
                { value: "Ross 128" },
                { value: "SOL" },
                { value: "SZ Crateris" },
                { value: "SZ Ursae Majoris" },
                { value: "Sanford 128" },
                { value: "Scholz&apos;s Star" },
                { value: "Sigma Cephei" },
                { value: "Sigma Tucanae" },
                { value: "Sirius" },
                { value: "Struve 2398" },
                { value: "TW Piscis Austrini" },
                { value: "TZ Arietis" },
                { value: "Tau Tucanae" },
                { value: "Theta Corvi" },
                { value: "Theta Horologii" },
                { value: "Unknown Yellow Dwarf" },
                { value: "Upsilon Cephei" },
                { value: "V1216 Sagittarii" },
                { value: "V547 Cassiopeiae" },
                { value: "Van Biesbroeck&apos;s Star" },
                { value: "Van Maanens Star" },
                { value: "Vyssotsky McCormic 541" },
                { value: "Woolley 9833" },
                { value: "Xi Bo√∂tis" },
                { value: "Xi Chamaeleontis" },
                { value: "Xi Fornacis" },
                { value: "Xi Leporis" },
                { value: "Xi Muscae" },
                { value: "YZ Ceti" },
                { value: "Zeta Carinae" },
                { value: "Zeta Herculis" },
                { value: "Zeta Sextantis" },
                { value: "Zeta-1 Reticuli" },
                { value: "kappa Ursae Minoris" }
            ], 30, false, true);
            document.getElementById('distancesTab').appendChild(systemFilter);

            // ?
            resetLabels([layer_Regions_0,layer_Systems_2]);
            map.on("zoomend", function(){
                resetLabels([layer_Regions_0,layer_Systems_2]);
            });
            map.on("layeradd", function(){
                resetLabels([layer_Regions_0,layer_Systems_2]);
            });
            map.on("layerremove", function(){
                resetLabels([layer_Regions_0,layer_Systems_2]);
            });

            // Center map
            map.setView([0.3, 0.6], 10.5);

            sel_Character.selectedIndex = 1; // Set default character journey to MC
            sel_Character.dispatchEvent(new Event('change')); 

            sel_Book.selectedIndex = 0; // Limit the default character journey scope to first book
            sel_Book.dispatchEvent(new Event('change'));

            map.removeLayer(layer_Characters_3); // Hide the character journey layer after setting default displays for character and book
            map.removeLayer(layer_Diplomacy_4); // Hide the diplomacy layer
        </script>
    </body>
</html>
